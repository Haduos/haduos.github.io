<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CAVE ZONE</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#0a0a0f;display:flex;flex-direction:column;align-items:center;
  justify-content:center;height:100vh;overflow:hidden;
  font-family:'Press Start 2P',monospace;color:#c8ff00;user-select:none;}
#gw{position:relative;border:3px solid #c8ff00;
  box-shadow:0 0 30px #c8ff0044,inset 0 0 30px #00000088;outline:none;}
canvas{display:block;image-rendering:pixelated;cursor:crosshair;}
/* TOP HUD */
#hud{position:absolute;top:0;left:0;right:0;padding:7px 12px;
  display:flex;justify-content:space-between;align-items:flex-start;
  pointer-events:none;background:linear-gradient(to bottom,#000000bb,transparent);}
.hb{display:flex;flex-direction:column;gap:3px;}
.hl{font-size:5px;color:#666;}
.hv{font-size:8px;color:#c8ff00;text-shadow:0 0 8px #c8ff00aa;}
#hpbar{width:110px;height:7px;background:#1a1a1a;border:1px solid #333;}
#hpfill{height:100%;background:#ff3030;box-shadow:0 0 5px #ff3030;transition:width .15s;}
/* OVERLAY */
#overlay{position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;background:#0a0a0fee;z-index:10;}
#overlay h1{font-size:18px;color:#c8ff00;text-shadow:0 0 20px #c8ff00;
  margin-bottom:14px;letter-spacing:2px;}
.sub{font-size:6px;color:#999;margin-bottom:20px;text-align:center;line-height:2.6;}
.sub b{color:#c8ff00;}.sub span{color:#ff88cc;}
.btn{font-family:'Press Start 2P',monospace;font-size:9px;background:none;
  border:2px solid #c8ff00;color:#c8ff00;padding:9px 20px;cursor:pointer;
  text-shadow:0 0 8px #c8ff00;box-shadow:0 0 14px #c8ff0033;transition:all .15s;margin:3px;}
.btn:hover{background:#c8ff0022;box-shadow:0 0 28px #c8ff0088;}
/* MISC */
#minimap{position:absolute;bottom:90px;right:10px;border:1px solid #c8ff0033;}
#kills{position:absolute;bottom:90px;left:10px;font-size:6px;
  color:#ff6060;text-shadow:0 0 7px #ff3030;}
#announce{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);
  font-size:13px;color:#ff3030;text-shadow:0 0 18px #ff3030;
  pointer-events:none;opacity:0;transition:opacity .4s;z-index:5;white-space:nowrap;}
#stealthHud{position:absolute;bottom:90px;left:50%;transform:translateX(-50%);
  font-size:6px;color:#88ccff;text-shadow:0 0 8px #88ccffaa;opacity:0;transition:opacity .3s;}
#soundBtn{position:absolute;top:34px;right:8px;font-family:'Press Start 2P',monospace;
  font-size:6px;background:none;border:1px solid #444;color:#777;
  padding:3px 5px;cursor:pointer;z-index:20;}
#soundBtn:hover{border-color:#c8ff00;color:#c8ff00;}
/* BOTTOM HUD CANVAS */
#bottomHud{position:absolute;bottom:0;left:0;right:0;height:82px;
  pointer-events:none;background:linear-gradient(to top,#000000ee,#000000aa,transparent);}
</style>
</head>
<body>
<div id="gw" tabindex="0">
  <canvas id="c"></canvas>
  <!-- TOP HUD -->
  <div id="hud">
    <div class="hb">
      <span class="hl">Ğ—Ğ”ĞĞ ĞĞ’Ğ¬Ğ•</span>
      <div id="hpbar"><div id="hpfill"></div></div>
    </div>
    <div class="hb" style="text-align:center">
      <span class="hl">Ğ’ĞĞ›ĞĞ</span>
      <span class="hv" id="waveNum">1</span>
    </div>
    <div class="hb" style="text-align:right">
      <span class="hl">Ğ£Ğ‘Ğ˜Ğ™Ğ¡Ğ¢Ğ’</span>
      <span class="hv" id="kills">0</span>
    </div>
  </div>
  <!-- OVERLAY -->
  <div id="overlay">
    <h1>âš” CAVE ZONE</h1>
    <div class="sub">
      <b>WASD / â†‘â†“â†â†’</b> â€” Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ &nbsp; <b>Ğ›ĞšĞœ</b> â€” Ğ¾Ğ³Ğ¾Ğ½ÑŒ<br>
      <b>1 / 2</b> â€” Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑĞ»Ğ¾Ñ‚ Ğ¾Ñ€ÑƒĞ¶Ğ¸Ñ &nbsp; <b>R</b> â€” Ğ¿ĞµÑ€ĞµĞ·Ğ°Ñ€ÑĞ´ĞºĞ°<br>
      <b>E</b> â€” Ğ¿Ğ¾Ğ´Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚ / Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ÑÑƒĞ½Ğ´ÑƒĞº / Ñ‚Ğ¸Ñ…Ğ¾Ğµ ÑƒÑÑ‚Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ<br>
      <b>SHIFT</b> â€” ÑĞºÑ€Ñ‹Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ (Ğ½ĞµĞ²Ğ¸Ğ´Ğ¸Ğ¼ ÑĞ·Ğ°Ğ´Ğ¸ Ğ´Ğ»Ñ Ğ·Ğ¾Ğ¼Ğ±Ğ¸)<br>
      <b>3â€“6</b> â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚ Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ñ &nbsp; <b>F</b> â€” Ñ€ĞµĞ¶Ğ¸Ğ¼ ĞºĞ¾Ğ¿ĞºĞ¸ (ĞºĞ¸Ñ€ĞºĞ°)<br>
      <span>ĞŸĞµÑ‰ĞµÑ€Ñ‹ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹. ĞšĞ¸Ñ€ĞºĞ° Ğ¸Ğ· ÑÑƒĞ½Ğ´ÑƒĞºĞ° â€” ĞºĞ¾Ğ¿Ğ°Ğ¹ ÑÑ‚ĞµĞ½Ñ‹!</span>
    </div>
    <button class="btn" id="startBtn">â–¶ ĞĞĞ§ĞĞ¢Ğ¬</button>
  </div>
  <!-- BOTTOM HUD CANVAS -->
  <canvas id="bottomHud"></canvas>
  <!-- MISC -->
  <canvas id="minimap" width="100" height="76"></canvas>
  <div id="stealthHud">ğŸ‘ Ğ¡ĞšĞ Ğ«Ğ¢ĞĞĞ¡Ğ¢Ğ¬</div>
  <div id="announce"></div>
  <button id="soundBtn">ğŸ”Š</button>
</div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let AC=null,soundOn=true;
function initAC(){if(!AC)AC=new(window.AudioContext||window.webkitAudioContext)();if(AC.state==='suspended')AC.resume();}
document.getElementById('soundBtn').onclick=()=>{soundOn=!soundOn;document.getElementById('soundBtn').textContent=soundOn?'ğŸ”Š':'ğŸ”‡';};

function noise(dur,dec,freq,vol,ftype='bandpass'){
  if(!soundOn||!AC)return;
  try{const now=AC.currentTime,len=Math.floor(AC.sampleRate*dur),buf=AC.createBuffer(1,len,AC.sampleRate),d=buf.getChannelData(0);
    for(let i=0;i<len;i++)d[i]=(Math.random()*2-1)*Math.exp(-i/(len*dec));
    const src=AC.createBufferSource();src.buffer=buf;
    const g=AC.createGain();g.gain.setValueAtTime(vol,now);
    const f=AC.createBiquadFilter();f.type=ftype;f.frequency.value=freq;f.Q.value=0.7;
    src.connect(f);f.connect(g);g.connect(AC.destination);src.start(now);
  }catch(e){}
}
function tone(freq,dur,vol,type='square',delay=0){
  if(!soundOn||!AC)return;
  try{const now=AC.currentTime+delay,osc=AC.createOscillator(),g=AC.createGain();
    osc.type=type;osc.frequency.setValueAtTime(freq,now);
    g.gain.setValueAtTime(vol,now);g.gain.exponentialRampToValueAtTime(0.001,now+dur);
    osc.connect(g);g.connect(AC.destination);osc.start(now);osc.stop(now+dur+0.01);
  }catch(e){}
}
const SFX={
  pistol:   ()=>noise(.13,.09,900,.35),
  revolver: ()=>{noise(.2,.06,500,.6);tone(200,.15,.05,'sawtooth');},
  deagle:   ()=>{noise(.22,.05,350,.65);noise(.1,.4,120,.1,'lowpass');},
  smg:      ()=>noise(.06,.13,700,.22),
  ak47:     ()=>noise(.09,.1,650,.32),
  m16:      ()=>noise(.07,.11,700,.28),
  m1garand: ()=>noise(.18,.07,400,.45),
  shotgun:  ()=>noise(.22,.06,300,.7,'lowpass'),
  awp:      ()=>{noise(.28,.04,200,.65);noise(.08,.5,1400,.15);},
  barret:   ()=>{noise(.32,.03,150,.75);noise(.1,.6,1600,.2);},
  minigun:  ()=>noise(.04,.2,800,.18),
  hit:      ()=>noise(.09,.3,100,.28,'lowpass'),
  death:    ()=>{noise(.35,.2,80,.45,'lowpass');tone(55,.2,.08,'sawtooth');},
  stealthkill:()=>{noise(.08,.5,600,.1);tone(200,.05,.06,'square');},
  // Chest open â€” dramatic wooden creak + jingle
  chestOpen:()=>{
    noise(.15,.2,200,.15,'lowpass');
    setTimeout(()=>{tone(523,.08,.18,'square');tone(659,.1,.18,'square',.09);tone(784,.15,.2,'square',.18);},100);
  },
  weaponSelect:()=>{tone(440,.04,.12,'square');tone(550,.04,.1,'square',.05);},
  reload:   ()=>{noise(.05,.5,300,.1);setTimeout(()=>noise(.05,.5,500,.12),180);},
  reloadEnd:()=>{tone(300,.05,.16,'square');tone(420,.07,.16,'square',.07);},
  empty:    ()=>noise(.05,.6,200,.08,'lowpass'),
  hurt:     ()=>noise(.14,.15,180,.38),
  club:     ()=>{noise(.1,.2,120,.3,'lowpass');tone(80,.08,.12,'sawtooth');},
  // Miramystin â€” clean medical ping
  healMira: ()=>{tone(880,.06,.18,'sine');tone(1046,.08,.18,'sine',.07);tone(1318,.12,.18,'sine',.15);},
  // Goz â€” magical shimmer
  healGoz:  ()=>{
    [523,659,784,1046,1318].forEach((f,i)=>{tone(f,.1,.15,'sine',i*.05);tone(f*1.5,.08,.08,'triangle',i*.05+.02);});
  },
  // Pickaxe dig â€” rock chunk impact
  digWall:  ()=>{noise(.12,.08,180,.5,'lowpass');setTimeout(()=>noise(.06,.4,300,.2,'bandpass'),80);},
  // Pickaxe equip mode toggle
  digMode:  ()=>{tone(330,.04,.15,'square');tone(440,.06,.12,'square',.05);},
  wave:     ()=>[80,100,60].forEach((f,i)=>tone(f,.35,.07,'sawtooth',i*.1)),
};
function snd(n){if(!soundOn)return;initAC();SFX[n]&&SFX[n]();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GW=800,GH=480; // game viewport height (canvas)
const BH=82;          // bottom hud height
const W=800,H=GH;
const TILE=20,COLS=40,ROWS=24;

const cv=document.getElementById('c');cv.width=W;cv.height=H;
const ctx=cv.getContext('2d');ctx.imageSmoothingEnabled=false;

const bhudc=document.getElementById('bottomHud');
bhudc.width=W;bhudc.height=BH;
const bhud=bhudc.getContext('2d');bhud.imageSmoothingEnabled=false;

const mm=document.getElementById('minimap');
const mctx=mm.getContext('2d');
const gw=document.getElementById('gw');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEAPON DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLUB_DEF={name:'Ğ”Ğ£Ğ‘Ğ˜ĞĞ',type:'melee',dmg:45,range:30,fireRate:28,color:'#aa6633',bw:16,bh:6};

const WDEFS={
  glock17:  {name:'GLOCK 17',     cat:'pistol', sfx:'pistol',  dmg:22,spd:9, range:330,spread:.06,ammo:17,maxAmmo:17,fireRate:18,color:'#aaaaaa',bw:13,bh:6,reloadTime:55,reservePerBox:17},
  deagle:   {name:'DESERT EAGLE', cat:'pistol', sfx:'deagle',  dmg:60,spd:12,range:400,spread:.04,ammo:7, maxAmmo:7, fireRate:38,color:'#888888',bw:15,bh:7,reloadTime:70,reservePerBox:14},
  revolver: {name:'COLT PYTHON',  cat:'pistol', sfx:'revolver',dmg:50,spd:11,range:360,spread:.03,ammo:6, maxAmmo:6, fireRate:35,color:'#cc9944',bw:14,bh:6,reloadTime:90,reservePerBox:12},
  usp:      {name:'USP-S',        cat:'pistol', sfx:'pistol',  dmg:28,spd:10,range:310,spread:.04,ammo:12,maxAmmo:12,fireRate:22,color:'#778877',bw:13,bh:6,reloadTime:52,reservePerBox:24,silenced:true},
  mp5:      {name:'MP5',          cat:'smg',    sfx:'smg',     dmg:14,spd:12,range:300,spread:.07,ammo:30,maxAmmo:30,fireRate:8, color:'#5577aa',bw:17,bh:5,reloadTime:65,reservePerBox:60},
  uzi:      {name:'UZI',          cat:'smg',    sfx:'smg',     dmg:10,spd:11,range:260,spread:.13,ammo:40,maxAmmo:40,fireRate:5, color:'#88ffcc',bw:15,bh:5,reloadTime:70,reservePerBox:80},
  p90:      {name:'P90',          cat:'smg',    sfx:'smg',     dmg:12,spd:13,range:310,spread:.08,ammo:50,maxAmmo:50,fireRate:6, color:'#55aacc',bw:18,bh:6,reloadTime:78,reservePerBox:100},
  thompson: {name:'THOMPSON M1A', cat:'smg',    sfx:'smg',     dmg:20,spd:9, range:270,spread:.1, ammo:30,maxAmmo:30,fireRate:10,color:'#996633',bw:19,bh:6,reloadTime:85,reservePerBox:60},
  ak47:     {name:'AK-47',        cat:'rifle',  sfx:'ak47',    dmg:20,spd:13,range:490,spread:.05,ammo:30,maxAmmo:30,fireRate:8, color:'#aa8833',bw:21,bh:5,reloadTime:80,reservePerBox:60},
  m16:      {name:'M16A4',        cat:'rifle',  sfx:'m16',     dmg:18,spd:14,range:520,spread:.03,ammo:30,maxAmmo:30,fireRate:7, color:'#336655',bw:21,bh:5,reloadTime:75,reservePerBox:60},
  m1garand: {name:'M1 GARAND',    cat:'rifle',  sfx:'m1garand',dmg:38,spd:13,range:500,spread:.03,ammo:8, maxAmmo:8, fireRate:22,color:'#885533',bw:23,bh:5,reloadTime:70,reservePerBox:24},
  scar:     {name:'SCAR-H',       cat:'rifle',  sfx:'ak47',    dmg:25,spd:13,range:510,spread:.04,ammo:20,maxAmmo:20,fireRate:10,color:'#998844',bw:21,bh:5,reloadTime:80,reservePerBox:40},
  spas12:   {name:'SPAS-12',      cat:'shotgun',sfx:'shotgun', dmg:22,spd:7, range:200,spread:.28,ammo:8, maxAmmo:8, fireRate:42,pellets:6,color:'#ff8833',bw:19,bh:7,reloadTime:100,reservePerBox:24},
  mossberg: {name:'MOSSBERG 500', cat:'shotgun',sfx:'shotgun', dmg:25,spd:7, range:190,spread:.32,ammo:7, maxAmmo:7, fireRate:48,pellets:7,color:'#664422',bw:20,bh:7,reloadTime:105,reservePerBox:21},
  awp:      {name:'AWP',          cat:'sniper', sfx:'awp',     dmg:130,spd:19,range:820,spread:.007,ammo:5,maxAmmo:5,fireRate:85,color:'#99cc44',bw:25,bh:5,reloadTime:115,reservePerBox:10},
  barret:   {name:'BARRETT M82',  cat:'sniper', sfx:'barret',  dmg:160,spd:22,range:900,spread:.004,ammo:10,maxAmmo:10,fireRate:95,color:'#666666',bw:27,bh:6,reloadTime:125,reservePerBox:10},
  minigun:  {name:'MINIGUN',      cat:'mg',     sfx:'minigun', dmg:11,spd:15,range:420,spread:.18,ammo:150,maxAmmo:150,fireRate:3,color:'#ff5500',bw:22,bh:9,reloadTime:220,reservePerBox:150},
};
const WKEYS=Object.keys(WDEFS);
function mkWeapon(k){const d=WDEFS[k];return{...d,key:k,ammo:d.maxAmmo,totalAmmo:d.reservePerBox*2};}

// Consumable definitions
const ITEMS={
  miramystin:{name:'ĞœĞ˜Ğ ĞĞœĞ˜Ğ¡Ğ¢Ğ˜Ğ', healPct:.35, color:'#44aaff', glow:'#44aaffaa', emoji:'ğŸ’Š', rarity:'common'},
  goz:       {name:'Ğ“ĞĞ—',        healPct:.55, color:'#ff44cc', glow:'#ff44ccaa', emoji:'ğŸ«', rarity:'rare'},
  pickaxe:   {name:'ĞšĞ˜Ğ ĞšĞ',      color:'#ccbbaa', glow:'#ccbbaa66', emoji:'â›',  rarity:'tool', permanent:true},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let map,visited,player,enemies,bullets,chests,floorItems,particles;
let wave=1,waveTimer=0,frameCount=0,gameActive=false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keys2={},mouse={x:W/2,y:H/2,down:false};
function onKD(e){
  keys2[e.key]=true;
  if(gameActive){
    const k=e.key;
    if(k==='r'||k==='R'||k==='Ğº'||k==='Ğš')doReload();
    if(k==='Shift')toggleStealth();
    if(k==='1')selectSlot(0);
    if(k==='2')selectSlot(1);
    if(k==='3')useItem(0);
    if(k==='4')useItem(1);
    if(k==='5')useItem(2);
    if(k==='6')useItem(3);
    if(k==='f'||k==='F'||k==='Ğ°'||k==='Ğ')tryToggleDigMode();
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(k))e.preventDefault();
  }
}
function onKU(e){keys2[e.key]=false;}
[window,document,gw].forEach(el=>{
  el.addEventListener('keydown',onKD,{capture:true});
  el.addEventListener('keyup',onKU,{capture:true});
});
window.addEventListener('mousemove',e=>{
  const r=cv.getBoundingClientRect();
  mouse.x=(e.clientX-r.left)*(W/r.width);
  mouse.y=(e.clientY-r.top)*(H/r.height);
});
cv.addEventListener('mousedown',e=>{
  initAC();gw.focus();e.preventDefault();
  if(player&&player.digMode){tryDig();return;}
  mouse.down=true;
});
window.addEventListener('mouseup',()=>mouse.down=false);
cv.addEventListener('contextmenu',e=>e.preventDefault());
cv.addEventListener('touchstart',e=>{
  e.preventDefault();mouse.down=true;initAC();gw.focus();
  const t=e.touches[0],r=cv.getBoundingClientRect();
  mouse.x=(t.clientX-r.left)*(W/r.width);mouse.y=(t.clientY-r.top)*(H/r.height);
},{passive:false});
cv.addEventListener('touchmove',e=>{
  e.preventDefault();const t=e.touches[0],r=cv.getBoundingClientRect();
  mouse.x=(t.clientX-r.left)*(W/r.width);mouse.y=(t.clientY-r.top)*(H/r.height);
},{passive:false});
cv.addEventListener('touchend',e=>{e.preventDefault();mouse.down=false;},{passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CAVE GEN â€” guaranteed connected via flood-fill + tunnel carving
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SPAWN_R=4, SPAWN_C=5; // spawn tile

function genCave(){
  let m, tries=0;
  do { m=genCaveRaw(); tries++; } while(!isConnected(m) && tries<8);
  if(!isConnected(m)) m=connectCave(m);
  return m;
}

function genCaveRaw(){
  let m=[];
  for(let r=0;r<ROWS;r++){m[r]=[];for(let c=0;c<COLS;c++)m[r][c]=(r===0||r===ROWS-1||c===0||c===COLS-1)?1:(Math.random()<.43?1:0);}
  for(let i=0;i<5;i++)m=smoothMap(m);
  // Always clear spawn area
  for(let r=2;r<9;r++)for(let c=2;c<12;c++)m[r][c]=0;
  return m;
}

function smoothMap(m){
  const n=[];
  for(let r=0;r<ROWS;r++){n[r]=[];for(let c=0;c<COLS;c++){let w=0;for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){const nr=r+dr,nc=c+dc;w+=(nr<0||nr>=ROWS||nc<0||nc>=COLS)?1:m[nr][nc];}n[r][c]=w>4?1:0;}}
  return n;
}

// BFS flood-fill from spawn, returns visited grid
function floodFill(m,sr,sc){
  const vis=Array.from({length:ROWS},()=>new Uint8Array(COLS));
  if(m[sr][sc])return vis; // spawn is a wall, skip
  const q=[{r:sr,c:sc}]; vis[sr][sc]=1;
  while(q.length){
    const {r,c}=q.shift();
    for(const [dr,dc] of [[-1,0],[1,0],[0,-1],[0,1]]){
      const nr=r+dr,nc=c+dc;
      if(nr>=0&&nr<ROWS&&nc>=0&&nc<COLS&&!vis[nr][nc]&&!m[nr][nc]){vis[nr][nc]=1;q.push({r:nr,c:nc});}
    }
  }
  return vis;
}

function isConnected(m){
  const reach=floodFill(m,SPAWN_R,SPAWN_C);
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)if(!m[r][c]&&!reach[r][c])return false;
  return true;
}

// Carve L-shaped tunnels until every floor tile is reachable from spawn
function connectCave(m){
  let safety=60;
  while(!isConnected(m)&&safety-->0){
    const reach=floodFill(m,SPAWN_R,SPAWN_C);
    // Pick first unreachable floor tile
    let target=null;
    outer:for(let r=1;r<ROWS-1;r++)for(let c=1;c<COLS-1;c++)if(!m[r][c]&&!reach[r][c]){target={r,c};break outer;}
    if(!target)break;
    // Find nearest reachable floor tile
    let best=null,bestD=Infinity;
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
      if(!m[r][c]&&reach[r][c]){const d=Math.hypot(r-target.r,c-target.c);if(d<bestD){bestD=d;best={r,c};}}
    }
    if(!best)break;
    // Carve corridor: horizontal first, then vertical
    let r=target.r,c=target.c;
    while(c!==best.c){m[r][c]=0;c+=(best.c>c)?1:-1;}
    while(r!==best.r){m[r][c]=0;r+=(best.r>r)?1:-1;}
    m[r][c]=0;
    // Widen tunnel slightly so player can pass (2-wide)
    for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
      const nr=r+dr,nc=c+dc;
      if(nr>0&&nr<ROWS-1&&nc>0&&nc<COLS-1)m[nr][nc]=0;
    }
  }
  return m;
}

// Only return floor tiles reachable from spawn
function reachableFloors(){
  const reach=floodFill(map,SPAWN_R,SPAWN_C);
  const t=[];
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)if(!map[r][c]&&reach[r][c])t.push({r,c});
  return t;
}

function floors(){const t=[];for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)if(!map[r][c])t.push({r,c});return t;}
function randFloor(minD=8){
  const all=reachableFloors(),far=all.filter(t=>Math.abs(t.r-SPAWN_R)>minD||Math.abs(t.c-SPAWN_C)>minD);
  const pool=far.length?far:all;
  if(!pool.length)return{x:SPAWN_C*TILE+TILE/2,y:SPAWN_R*TILE+TILE/2};
  const t=pool[Math.floor(Math.random()*pool.length)];
  return{x:t.c*TILE+TILE/2,y:t.r*TILE+TILE/2};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('startBtn').addEventListener('click',()=>{initAC();startGame();});
function startGame(){
  document.getElementById('overlay').style.display='none';
  wave=1;gameActive=true;
  document.getElementById('kills').textContent='0';
  document.getElementById('waveNum').textContent='1';
  initLevel();requestAnimationFrame(loop);gw.focus();
}
function initLevel(){
  map=genCave();
  visited=Array.from({length:ROWS},()=>new Uint8Array(COLS));
  bullets=[];particles=[];floorItems=[];
  player={
    x:SPAWN_C*TILE+TILE/2,y:SPAWN_R*TILE+TILE/2,w:12,h:14,spd:2.4,
    hp:100,maxHp:100,
    weapons:[mkWeapon('glock17'),null], // 2 weapon slots
    activeSlot:0,
    inventory:[],   // consumables + tools, max 4
    digMode:false,  // pickaxe dig mode
    digCooldown:0,
    fireCooldown:0,reloading:0,
    angle:0,iFrames:0,
    stealth:false,knifeAnim:0,clubAnim:0,clubSwingDir:1,
  };
  chests=[];
  const cnt=4+Math.floor(wave/2);
  for(let i=0;i<cnt;i++){
    const p=randFloor();
    chests.push({x:p.x,y:p.y,open:false,glow:Math.random()*Math.PI*2,collected:false});
  }
  enemies=[];spawnWave();
}
function spawnWave(){
  const count=5+wave*3;
  for(let i=0;i<count;i++){
    const p=randFloor(),mut=wave>=2&&Math.random()<.3+wave*.04;
    enemies.push(mkEnemy(p.x,p.y,mut));
  }
  showAnn('âš¡ Ğ’ĞĞ›ĞĞ '+wave);snd('wave');
  document.getElementById('waveNum').textContent=wave;
}
function mkEnemy(x,y,mut=false){
  return{x,y,w:14,h:16,
    hp:mut?80+wave*15:40+wave*8,maxHp:mut?80+wave*15:40+wave*8,
    spd:mut?1.2+wave*.07:.7+wave*.05,dmg:mut?15:8,
    type:mut?'mutant':'zombie',state:'wander',
    facingAngle:Math.random()*Math.PI*2,wanderAngle:Math.random()*Math.PI*2,
    wanderTimer:0,attackCooldown:0,hitFlash:0,deathAnim:0,alert:0};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEAPON SLOT HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getWeapon(){return player.weapons[player.activeSlot]||null;}
function selectSlot(idx){
  if(idx<0||idx>1)return;
  player.activeSlot=idx;
  player.reloading=0;
  snd('weaponSelect');
}
function hasEmptySlot(){return player.weapons[0]===null||player.weapons[1]===null;}
function firstEmptySlot(){if(player.weapons[0]===null)return 0;if(player.weapons[1]===null)return 1;return -1;}

// Drop active weapon to floor
function dropWeapon(slot){
  const w=player.weapons[slot];
  if(!w||w.type==='melee')return;
  floorItems.push({type:'weapon',wkey:w.key,x:player.x+(Math.random()*20-10),y:player.y+(Math.random()*20-10),bob:0,lifetime:900,collected:false,w});
  player.weapons[slot]=null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COLLISION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tileAt(x,y){const c=Math.floor(x/TILE),r=Math.floor(y/TILE);if(r<0||r>=ROWS||c<0||c>=COLS)return 1;return map[r][c];}
function moveEnt(e,dx,dy){
  const hw=e.w/2,hh=e.h/2,nx=e.x+dx,ny=e.y+dy;
  if(!tileAt(nx-hw+1,e.y-hh+1)&&!tileAt(nx+hw-1,e.y-hh+1)&&!tileAt(nx-hw+1,e.y+hh-1)&&!tileAt(nx+hw-1,e.y+hh-1))e.x=nx;
  if(!tileAt(e.x-hw+1,ny-hh+1)&&!tileAt(e.x+hw-1,ny-hh+1)&&!tileAt(e.x-hw+1,ny+hh-1)&&!tileAt(e.x+hw-1,ny+hh-1))e.y=ny;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEALTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleStealth(){if(!gameActive)return;player.stealth=!player.stealth;document.getElementById('stealthHud').style.opacity=player.stealth?'1':'0';}
function angleDiff(a,b){let d=b-a;while(d>Math.PI)d-=Math.PI*2;while(d<-Math.PI)d+=Math.PI*2;return d;}
function enemyCanSee(e){
  const dist=Math.hypot(player.x-e.x,player.y-e.y);
  if(!player.stealth)return dist<200;
  if(dist<50)return true;
  const angToP=Math.atan2(player.y-e.y,player.x-e.x);
  const diff=Math.abs(angleDiff(e.facingAngle,angToP));
  return diff<1.1&&dist<120;
}
function canStealthKill(e){
  if(!player.stealth||e.deathAnim>0||e.hp<=0||e.type!=='zombie')return false;
  if(Math.hypot(player.x-e.x,player.y-e.y)>28)return false;
  const angToP=Math.atan2(player.y-e.y,player.x-e.x);
  return Math.abs(angleDiff(e.facingAngle,angToP))>1.3;
}
function doStealthKill(e){
  spawnBlood(e.x,e.y,20);e.hp=0;e.deathAnim=25;
  const k=parseInt(document.getElementById('kills').textContent)+1;
  document.getElementById('kills').textContent=k;
  player.knifeAnim=25;snd('stealthkill');
  maybeDropAmmo(e.x,e.y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHOOTING / MELEE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doShoot(){
  const w=getWeapon();
  // No weapon at all â†’ club
  if(!w){doClub();return;}
  if(w.type==='melee'){doClub();return;}
  if(player.reloading>0)return;
  if(w.ammo<=0){
    if(w.totalAmmo===0){
      // Switch to club if other slot also empty
      const other=player.weapons[1-player.activeSlot];
      if(!other||other.ammo===0&&other.totalAmmo===0){player.weapons[player.activeSlot]=null;showAnn('ğŸªµ Ğ”Ğ£Ğ‘Ğ˜ĞĞ!');}
      snd('empty');
    } else { doReload(); }
    return;
  }
  if(player.fireCooldown>0)return;
  player.fireCooldown=w.fireRate;
  const count=w.pellets||1;
  for(let i=0;i<count;i++){
    const sp=(Math.random()-.5)*w.spread,ang=player.angle+sp;
    bullets.push({x:player.x,y:player.y,vx:Math.cos(ang)*w.spd,vy:Math.sin(ang)*w.spd,
      dmg:w.dmg,life:w.range,color:w.color||'#ffe066',owner:'player',silenced:!!w.silenced});
  }
  w.ammo--;
  if(!w.silenced)for(let i=0;i<8;i++)spawnPart(player.x,player.y,'#ffe066',1.5+Math.random()*2.5,24);
  snd(w.silenced?'':w.sfx);
}
function doClub(){
  if(player.fireCooldown>0)return;
  player.fireCooldown=CLUB_DEF.fireRate;
  player.clubAnim=15;player.clubSwingDir*=-1;snd('club');
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];if(e.deathAnim>0)continue;
    if(Math.hypot(player.x-e.x,player.y-e.y)<CLUB_DEF.range+12){
      e.hp-=CLUB_DEF.dmg;e.hitFlash=8;spawnBlood(e.x,e.y,5);snd('hit');
      if(e.hp<=0){killEnemy(e);}
    }
  }
}
function doReload(){
  const w=getWeapon();if(!w||w.type==='melee'||player.reloading>0)return;
  if(w.ammo===w.maxAmmo||w.totalAmmo===0){if(w.totalAmmo===0)snd('empty');return;}
  player.reloading=w.reloadTime;snd('reload');showAnn('â†º ĞŸĞ•Ğ Ğ•Ğ—ĞĞ Ğ¯Ğ”ĞšĞ...');
}
function finishReload(){
  const w=getWeapon();if(!w||w.type==='melee')return;
  const need=w.maxAmmo-w.ammo,take=Math.min(need,w.totalAmmo);
  w.ammo+=take;w.totalAmmo-=take;snd('reloadEnd');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSUMABLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function useItem(idx){
  if(!player.inventory[idx])return;
  const item=player.inventory[idx];
  const def=ITEMS[item.type];
  // Pickaxe â€” toggle dig mode instead of consuming
  if(item.type==='pickaxe'){tryToggleDigMode();return;}
  const heal=Math.round(player.maxHp*def.healPct);
  player.hp=Math.min(player.maxHp,player.hp+heal);
  player.inventory.splice(idx,1);
  showAnn(def.emoji+' '+def.name+' +'+heal+'HP');
  snd(item.type==='goz'?'healGoz':'healMira');
  // Particles
  const col=def.color;
  for(let i=0;i<20;i++)spawnPart(player.x,player.y,col,2+Math.random()*2,50);
  document.getElementById('hpfill').style.width=(player.hp/player.maxHp*100)+'%';
}

function hasPickaxe(){return player.inventory.some(i=>i&&i.type==='pickaxe');}
function tryToggleDigMode(){
  if(!hasPickaxe()){showAnn('â› ĞĞµÑ‚ ĞºĞ¸Ñ€ĞºĞ¸!');return;}
  player.digMode=!player.digMode;
  snd('digMode');
  showAnn(player.digMode?'â› Ğ Ğ•Ğ–Ğ˜Ğœ ĞšĞĞŸĞšĞ˜ (Ğ›ĞšĞœ)':'â› Ğ ĞµĞ¶Ğ¸Ğ¼ ĞºĞ¾Ğ¿ĞºĞ¸ Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½');
}

// Called when LMB clicked in dig mode
function tryDig(){
  if(!player.digMode||player.digCooldown>0)return;
  const DIG_RANGE=2.8*TILE; // tiles range
  const mx=mouse.x,my=mouse.y;
  const dist=Math.hypot(mx-player.x,my-player.y);
  if(dist>DIG_RANGE){showAnn('â› Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ´Ğ°Ğ»ĞµĞºĞ¾!');return;}
  const tc=Math.floor(mx/TILE),tr=Math.floor(my/TILE);
  if(tr<1||tr>=ROWS-1||tc<1||tc>=COLS-1)return; // never dig border
  if(!map[tr][tc])return; // already floor
  // Dig it!
  map[tr][tc]=0;
  player.digCooldown=40; // frames
  snd('digWall');
  // Dust particles
  const wx=tc*TILE+TILE/2,wy=tr*TILE+TILE/2;
  for(let i=0;i<16;i++)spawnPart(wx,wy,'#8B7355',1.5+Math.random()*2,45);
  for(let i=0;i<8;i++)spawnPart(wx,wy,'#ccbbaa',1+Math.random()*1.5,30);
  // Reveal dug tile in fog
  if(tr>=0&&tr<ROWS&&tc>=0&&tc<COLS)visited[tr][tc]=1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHESTS & FLOOR ITEMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tryOpenChest(){
  for(const c of chests){
    if(c.open||c.collected)continue;
    if(Math.hypot(player.x-c.x,player.y-c.y)<36){
      c.open=true;snd('chestOpen');
      for(let i=0;i<22;i++)spawnPart(c.x,c.y,'#ffaa22',3,65);
      for(let i=0;i<8;i++)spawnPart(c.x,c.y,'#ffffff',1.5,35);
      // Always drop 1 weapon
      const wk=WKEYS[Math.floor(Math.random()*WKEYS.length)];
      spawnFloorWeapon(c.x-16+Math.random()*32,c.y-16+Math.random()*32,wk);
      // Drop consumables
      const roll=Math.random();
      if(roll<0.7){spawnFloorItem(c.x+10+Math.random()*16,c.y-8+Math.random()*16,'miramystin');}
      if(roll<0.25){spawnFloorItem(c.x-16+Math.random()*8,c.y-8+Math.random()*16,'goz');}
      // Rare pickaxe drop
      if(Math.random()<0.18){spawnFloorItem(c.x+Math.random()*20-10,c.y+Math.random()*20-10,'pickaxe');}
      // Sometimes extra ammo box
      if(Math.random()<0.5){
        const wkCur=player.weapons[player.activeSlot];
        if(wkCur&&wkCur.type!=='melee'){
          wkCur.totalAmmo+=wkCur.reservePerBox||30;
          spawnPart(player.x,player.y,'#c8ff00',2,40);
        }
      }
      break;
    }
  }
}

function spawnFloorWeapon(x,y,wk){
  floorItems.push({type:'weapon',wkey:wk,x,y,bob:0,lifetime:900,collected:false});
}
function spawnFloorItem(x,y,itemType){
  floorItems.push({type:'item',itemType,x,y,bob:0,lifetime:900,collected:false});
}
function maybeDropAmmo(x,y){if(Math.random()<.3)floorItems.push({type:'ammobox',x,y,bob:0,lifetime:800,collected:false});}

function tryPickupFloor(){
  // Prefer stealth kill first
  for(let i=enemies.length-1;i>=0;i--){if(canStealthKill(enemies[i])){doStealthKill(enemies[i]);return;}}
  // Then chest
  let didChest=false;
  for(const c of chests)if(!c.open&&!c.collected&&Math.hypot(player.x-c.x,player.y-c.y)<36){tryOpenChest();didChest=true;break;}
  if(didChest)return;
  // Then floor items
  for(const fi of floorItems){
    if(fi.collected)continue;
    if(Math.hypot(player.x-fi.x,player.y-fi.y)>34)continue;
    if(fi.type==='weapon'){
      const empty=firstEmptySlot();
      if(empty!==-1){
        player.weapons[empty]=mkWeapon(fi.wkey);
        fi.collected=true;snd('weaponSelect');
        showAnn('ğŸ”« '+WDEFS[fi.wkey].name);
      } else {
        // Replace active slot
        dropWeapon(player.activeSlot);
        player.weapons[player.activeSlot]=mkWeapon(fi.wkey);
        fi.collected=true;snd('weaponSelect');
        showAnn('ğŸ”„ '+WDEFS[fi.wkey].name);
      }
      break;
    } else if(fi.type==='item'){
      const def=ITEMS[fi.itemType];
      // Pickaxe only 1 allowed
      if(fi.itemType==='pickaxe'&&player.inventory.some(i=>i&&i.type==='pickaxe')){
        showAnn('â› ĞšĞ¸Ñ€ĞºĞ° ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ!');break;
      }
      if(player.inventory.length<4){
        player.inventory.push({type:fi.itemType});
        fi.collected=true;snd('weaponSelect');
        showAnn(def.emoji+' ĞŸĞ¾Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ¾: '+def.name+(fi.itemType==='pickaxe'?' [F]':''));
      } else { showAnn('âš  Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ Ğ¿Ğ¾Ğ»Ğ¾Ğ½!'); }
      break;
    } else if(fi.type==='ammobox'){
      fi.collected=true;snd('weaponSelect');
      const w=getWeapon();
      if(w&&w.type!=='melee'){w.totalAmmo+=w.reservePerBox||30;showAnn('ğŸ”¹ ĞŸĞ°Ñ‚Ñ€Ğ¾Ğ½Ñ‹!');}
      else showAnn('ğŸ”¹ ĞŸĞ°Ñ‚Ñ€Ğ¾Ğ½Ñ‹ (Ğ½ĞµÑ‚ Ğ¾Ñ€ÑƒĞ¶Ğ¸Ñ)');
      break;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLES & BLOOD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnPart(x,y,color,spd,life){
  const a=Math.random()*Math.PI*2;
  particles.push({x,y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,life,maxLife:life,color,r:Math.random()*2+1});
}
function spawnBlood(x,y,n=8){for(let i=0;i<n;i++)spawnPart(x,y,Math.random()<.5?'#cc0000':'#880000',1+Math.random()*3.5,42);}
function killEnemy(e){
  e.deathAnim=25;e.hp=0;
  const k=parseInt(document.getElementById('kills').textContent)+1;
  document.getElementById('kills').textContent=k;
  spawnBlood(e.x,e.y,18);snd('death');
  maybeDropAmmo(e.x,e.y);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function update(){
  if(!gameActive)return;frameCount++;
  // Movement
  let dx=0,dy=0;
  if(keys2['w']||keys2['W']||keys2['ArrowUp']   ||keys2['Ñ†']||keys2['Ğ¦'])dy-=1;
  if(keys2['s']||keys2['S']||keys2['ArrowDown'] ||keys2['Ñ‹']||keys2['Ğ«'])dy+=1;
  if(keys2['a']||keys2['A']||keys2['ArrowLeft'] ||keys2['Ñ„']||keys2['Ğ¤'])dx-=1;
  if(keys2['d']||keys2['D']||keys2['ArrowRight']||keys2['Ğ²']||keys2['Ğ’'])dx+=1;
  if(dx&&dy){dx*=.707;dy*=.707;}
  const sp=player.stealth?player.spd*.42:player.spd;
  moveEnt(player,dx*sp,dy*sp);
  player.angle=Math.atan2(mouse.y-player.y,mouse.x-player.x);
  if(player.digCooldown>0)player.digCooldown--;
  if(mouse.down&&!player.digMode)doShoot();
  if(player.fireCooldown>0)player.fireCooldown--;
  if(player.knifeAnim>0)player.knifeAnim--;
  if(player.clubAnim>0)player.clubAnim--;
  if(player.iFrames>0)player.iFrames--;
  // E key
  if(keys2['e']||keys2['E']||keys2['Ñƒ']||keys2['Ğ£'])tryPickupFloor();
  // Reload
  if(player.reloading>0){
    player.reloading--;if(player.reloading===0)finishReload();
  }
  // FOW
  const pr=Math.floor(player.y/TILE),pc=Math.floor(player.x/TILE),vr=7;
  for(let r=pr-vr;r<=pr+vr;r++)for(let c=pc-vr;c<=pc+vr;c++)
    if(r>=0&&r<ROWS&&c>=0&&c<COLS&&Math.hypot(r-pr,c-pc)<=vr)visited[r][c]=1;
  // Chest glow
  for(const c of chests)c.glow+=.04;
  // Floor items bob
  for(const fi of floorItems){fi.bob+=.05;fi.lifetime--;if(fi.lifetime<=0)fi.collected=true;}
  floorItems=floorItems.filter(fi=>!fi.collected);
  // Enemies
  for(const e of enemies){
    if(e.deathAnim>0){e.deathAnim--;continue;}
    if(e.hitFlash>0)e.hitFlash--;
    if(e.attackCooldown>0)e.attackCooldown--;
    const dist=Math.hypot(player.x-e.x,player.y-e.y);
    const angToP=Math.atan2(player.y-e.y,player.x-e.x);
    if(enemyCanSee(e)){e.state='chase';e.wanderAngle=angToP;e.alert=Math.min(e.alert+1,20);}
    else{e.alert=Math.max(e.alert-1,0);if(e.alert===0)e.state='wander';
      if(--e.wanderTimer<=0){e.wanderTimer=60+Math.random()*120;e.wanderAngle+=(Math.random()-.5)*Math.PI;}}
    const mv=e.spd*(e.state==='chase'?1.1:.5);
    const px=e.x,py=e.y;moveEnt(e,Math.cos(e.wanderAngle)*mv,Math.sin(e.wanderAngle)*mv);
    if(Math.hypot(e.x-px,e.y-py)>.2)e.facingAngle=Math.atan2(e.y-py,e.x-px);
    if(dist<22&&e.attackCooldown===0&&player.iFrames===0){
      e.attackCooldown=60;player.hp-=e.dmg;player.iFrames=30;
      spawnBlood(player.x,player.y,5);snd('hurt');
      document.getElementById('hpfill').style.width=(player.hp/player.maxHp*100)+'%';
      if(player.hp<=0){gameOver();return;}
    }
    if(e.type==='mutant'&&dist<300&&dist>60&&e.attackCooldown===0){
      e.attackCooldown=100;const sp=(Math.random()-.5)*.14;
      bullets.push({x:e.x,y:e.y,vx:Math.cos(angToP+sp)*(4+wave*.18),vy:Math.sin(angToP+sp)*(4+wave*.18),dmg:10,life:300,color:'#ff4444',owner:'enemy'});
    }
  }
  // Bullets
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];b.x+=b.vx;b.y+=b.vy;b.life-=Math.hypot(b.vx,b.vy);
    if(tileAt(b.x,b.y)||b.life<=0){for(let p=0;p<4;p++)spawnPart(b.x,b.y,'#ffe066aa',1,14);bullets.splice(i,1);continue;}
    if(b.owner==='player'){
      for(let j=enemies.length-1;j>=0;j--){
        const e=enemies[j];if(e.deathAnim>0)continue;
        if(Math.abs(b.x-e.x)<e.w/2&&Math.abs(b.y-e.y)<e.h/2){
          e.hp-=b.dmg;e.hitFlash=8;spawnBlood(b.x,b.y);snd('hit');
          if(e.hp<=0)killEnemy(e);
          bullets.splice(i,1);break;
        }
      }
    } else if(player.iFrames===0&&Math.abs(b.x-player.x)<player.w/2&&Math.abs(b.y-player.y)<player.h/2){
      player.hp-=b.dmg;player.iFrames=20;spawnBlood(player.x,player.y,5);snd('hurt');
      document.getElementById('hpfill').style.width=(player.hp/player.maxHp*100)+'%';
      if(player.hp<=0){gameOver();return;}bullets.splice(i,1);
    }
  }
  // Particles
  for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vx*=.92;p.vy*=.92;p.life--;if(p.life<=0)particles.splice(i,1);}
  enemies=enemies.filter(e=>!(e.hp<=0&&e.deathAnim===0));
  // Wave logic
  if(enemies.length===0&&gameActive){
    waveTimer++;
    if(waveTimer>180){
      wave++;waveTimer=0;
      document.getElementById('waveNum').textContent=wave;
      if(wave%3===0){
        map=genCave();visited=Array.from({length:ROWS},()=>new Uint8Array(COLS));
        player.x=5*TILE+TILE/2;player.y=4*TILE+TILE/2;
        floorItems=[];chests=[];
        const cnt=4+Math.floor(wave/2);
        for(let i=0;i<cnt;i++){const p=randFloor();chests.push({x:p.x,y:p.y,open:false,glow:Math.random()*Math.PI*2,collected:false});}
      }
      spawnWave();
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER â€” GAME WORLD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  ctx.fillStyle='#050508';ctx.fillRect(0,0,W,H);
  // Tiles
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    if(!visited[r][c])continue;
    const x=c*TILE,y=r*TILE;
    if(map[r][c]){
      ctx.fillStyle=(r+c)%2===0?'#1a1a2e':'#16213e';ctx.fillRect(x,y,TILE,TILE);
      ctx.fillStyle='#ffffff08';ctx.fillRect(x,y,TILE,2);ctx.fillRect(x,y,2,TILE);
    } else {
      ctx.fillStyle=(r+c)%3===0?'#0d2d54':'#0f3460';ctx.fillRect(x,y,TILE,TILE);
      if((r*3+c*7)%11===0){ctx.fillStyle='#ffffff05';ctx.fillRect(x+6,y+6,4,4);}
    }
  }
  // Particles
  for(const p of particles){ctx.globalAlpha=p.life/p.maxLife;ctx.fillStyle=p.color;ctx.fillRect(p.x-p.r/2,p.y-p.r/2,p.r,p.r);}ctx.globalAlpha=1;
  // Chests
  ctx.textAlign='center';
  for(const c of chests){
    if(c.collected)continue;
    const g=Math.abs(Math.sin(c.glow));
    if(!c.open){
      ctx.shadowBlur=8+g*10;ctx.shadowColor='#ffaa22';
      ctx.fillStyle='#8B5E1A';ctx.fillRect(c.x-12,c.y-9,24,16);
      ctx.fillStyle='#6B4010';ctx.fillRect(c.x-12,c.y-9,24,5);
      ctx.fillStyle='#ccaa44';ctx.fillRect(c.x-12,c.y-6,24,2);ctx.fillRect(c.x-1,c.y-9,2,16);
      ctx.fillStyle='#ffcc44';ctx.fillRect(c.x-2,c.y+1,4,4);
      ctx.shadowBlur=0;
      if(Math.hypot(player.x-c.x,player.y-c.y)<42){
        ctx.fillStyle='#ffffffdd';ctx.font='5px "Press Start 2P"';ctx.fillText('[E] ĞĞ¢ĞšĞ Ğ«Ğ¢Ğ¬',c.x,c.y-16);
      }
    } else {
      ctx.fillStyle='#6B4010';ctx.fillRect(c.x-12,c.y+1,24,12);
      ctx.save();ctx.translate(c.x-12,c.y+1);ctx.rotate(-.55);
      ctx.fillStyle='#8B5E1A';ctx.fillRect(0,-3,24,5);ctx.restore();
    }
  }
  // Floor items
  for(const fi of floorItems){
    const bob=Math.sin(fi.bob)*3;
    const near=Math.hypot(player.x-fi.x,player.y-fi.y)<38;
    if(fi.type==='weapon'){
      const wd=WDEFS[fi.wkey];
      ctx.shadowBlur=12;ctx.shadowColor=wd.color||'#ffe066';
      ctx.fillStyle=wd.color||'#ffe066';ctx.fillRect(fi.x-wd.bw/2,fi.y-wd.bh/2+bob,wd.bw,wd.bh);
      ctx.fillStyle='#ffffff44';ctx.fillRect(fi.x+wd.bw/2-1,fi.y-1+bob,5,2);ctx.shadowBlur=0;
      ctx.fillStyle='#ffffffee';ctx.font='5px "Press Start 2P"';ctx.fillText('[E]',fi.x,fi.y-14+bob);
      ctx.fillStyle='#ffffffaa';ctx.font='4px "Press Start 2P"';ctx.fillText(wd.name,fi.x,fi.y-9+bob);
    } else if(fi.type==='item'){
      const def=ITEMS[fi.itemType];
      ctx.shadowBlur=14;ctx.shadowColor=def.glow;
      ctx.fillStyle=def.color;
      if(fi.itemType==='goz'){
        // Glowing pink berries
        ctx.beginPath();ctx.arc(fi.x-4,fi.y+bob,5,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(fi.x+4,fi.y+1+bob,5,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(fi.x,fi.y-5+bob,5,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#ffaaee';ctx.beginPath();ctx.arc(fi.x-4,fi.y-1+bob,2,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(fi.x+4,fi.y+bob,2,0,Math.PI*2);ctx.fill();
      } else {
        // Miramystin bottle
        ctx.fillRect(fi.x-4,fi.y-8+bob,8,12);
        ctx.fillStyle='#ffffff55';ctx.fillRect(fi.x-3,fi.y-7+bob,3,5);
        ctx.fillStyle='#ffffff88';ctx.fillRect(fi.x-2,fi.y-10+bob,4,3);
      }
      ctx.shadowBlur=0;
      ctx.fillStyle='#ffffffee';ctx.font='5px "Press Start 2P"';ctx.fillText('[E]',fi.x,fi.y-18+bob);
      ctx.fillStyle='#ffffffbb';ctx.font='4px "Press Start 2P"';ctx.fillText(def.name,fi.x,fi.y-13+bob);
    } else if(fi.type==='ammobox'){
      ctx.shadowBlur=8;ctx.shadowColor='#88ddff';
      ctx.fillStyle='#88ddff';ctx.fillRect(fi.x-6,fi.y-5+bob,12,10);
      ctx.fillStyle='#c8ff00';ctx.fillRect(fi.x-4,fi.y-3+bob,8,6);
      ctx.shadowBlur=0;
      ctx.fillStyle='#ffffffee';ctx.font='5px "Press Start 2P"';ctx.fillText('[E]',fi.x,fi.y-13+bob);
    }
    if(near){ctx.strokeStyle='#ffe066aa';ctx.lineWidth=1;ctx.strokeRect(fi.x-24,fi.y-24,48,48);}
  }
  // Enemies
  for(const e of enemies){
    if(e.deathAnim>0){ctx.globalAlpha=e.deathAnim/25;ctx.fillStyle=e.type==='mutant'?'#ff4444':'#44ff44';ctx.fillRect(e.x-e.w/2,e.y-e.h/2,e.w,e.h);ctx.globalAlpha=1;continue;}
    if(e.alert>10&&e.state==='chase'){ctx.fillStyle='#ffff00';ctx.font='8px "Press Start 2P"';ctx.textAlign='center';ctx.fillText('!',e.x,e.y-e.h/2-10);}
    const col=e.hitFlash>0?'#ffffff':(e.type==='mutant'?'#ff6b6b':'#6bff6b');
    ctx.fillStyle=col;ctx.fillRect(e.x-e.w/2,e.y-e.h/2,e.w,e.h);
    ctx.fillStyle='#cc0000';ctx.fillRect(e.x-4,e.y-3,3,3);ctx.fillRect(e.x+1,e.y-3,3,3);
    if(e.type==='mutant'){ctx.fillStyle='#ff8888';for(let si=-6;si<=6;si+=4){ctx.fillRect(e.x+si,e.y-e.h/2-3,2,5);}}
    const bw=e.w+6;ctx.fillStyle='#222';ctx.fillRect(e.x-bw/2,e.y-e.h/2-9,bw,3);
    ctx.fillStyle=e.type==='mutant'?'#ff4444':'#44ff44';ctx.fillRect(e.x-bw/2,e.y-e.h/2-9,bw*(e.hp/e.maxHp),3);
    if(canStealthKill(e)){
      ctx.strokeStyle='#88ccff88';ctx.lineWidth=1;ctx.strokeRect(e.x-e.w/2-3,e.y-e.h/2-3,e.w+6,e.h+6);
      ctx.fillStyle='#88ccff';ctx.font='5px "Press Start 2P"';ctx.textAlign='center';ctx.fillText('ğŸ”ª[E]',e.x,e.y-e.h/2-14);
    }
  }
  // Player
  const pl=player,blink=pl.iFrames>0&&Math.floor(pl.iFrames/4)%2===0;
  ctx.globalAlpha=(blink?.35:1)*(pl.stealth?.55:1);
  ctx.fillStyle='#00000055';ctx.fillRect(pl.x-pl.w/2+2,pl.y+pl.h/2-2,pl.w,4);
  ctx.fillStyle=pl.stealth?'#4488aa':'#c8ff00';ctx.fillRect(pl.x-pl.w/2,pl.y-pl.h/2,pl.w,pl.h);
  ctx.fillStyle='#e0e0b0';ctx.fillRect(pl.x-5,pl.y-pl.h/2-7,10,8);
  ctx.globalAlpha=1;
  if(pl.stealth){ctx.beginPath();ctx.arc(pl.x,pl.y,52,0,Math.PI*2);const sg=ctx.createRadialGradient(pl.x,pl.y,0,pl.x,pl.y,52);sg.addColorStop(0,'#88ccff11');sg.addColorStop(1,'#88ccff00');ctx.fillStyle=sg;ctx.fill();}
  // Weapon in hand
  const aw=getWeapon();
  if(pl.knifeAnim>0){
    ctx.save();ctx.translate(pl.x,pl.y);ctx.rotate(pl.angle);
    ctx.fillStyle='#cccccc';ctx.fillRect(4,-2,14,3);ctx.fillStyle='#ffaa00';ctx.fillRect(4,-3,5,5);ctx.restore();
  } else if(!aw||aw.type==='melee'){
    const sw=pl.clubAnim>0?(pl.clubAnim/15)*.8*pl.clubSwingDir:0;
    ctx.save();ctx.translate(pl.x,pl.y);ctx.rotate(pl.angle+sw);
    ctx.fillStyle='#aa6633';ctx.fillRect(3,-3,16,6);ctx.fillStyle='#cc8844';ctx.fillRect(15,-3,4,6);ctx.restore();
  } else {
    ctx.save();ctx.translate(pl.x,pl.y);ctx.rotate(pl.angle);
    ctx.fillStyle=aw.color||'#ffdd88';ctx.fillRect(4,-aw.bh/2,aw.bw||14,aw.bh||5);
    if(!aw.silenced){ctx.fillStyle='#ffffff44';ctx.fillRect(4+(aw.bw||14),-1,5,2);}
    else{ctx.fillStyle='#778877';ctx.fillRect(4+(aw.bw||14),-2,8,4);}
    ctx.restore();
  }
  // Bullets
  for(const b of bullets){ctx.shadowBlur=6;ctx.shadowColor=b.color;ctx.fillStyle=b.color;const sz=b.owner==='enemy'?4:3;ctx.fillRect(b.x-sz,b.y-sz/2,sz*2,sz);}ctx.shadowBlur=0;
  // FOW
  const pr2=Math.floor(pl.y/TILE),pc2=Math.floor(pl.x/TILE),vr2=7;
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    if(!visited[r][c]){ctx.fillStyle='#050508';ctx.fillRect(c*TILE,r*TILE,TILE,TILE);}
    else if(Math.hypot(r-pr2,c-pc2)>vr2-1){ctx.fillStyle='#050508cc';ctx.fillRect(c*TILE,r*TILE,TILE,TILE);}
  }
  // Dig mode overlay â€” highlight target tile and range
  if(player.digMode){
    const DIG_RANGE=2.8*TILE;
    const tc=Math.floor(mouse.x/TILE),tr=Math.floor(mouse.y/TILE);
    const inRange=Math.hypot(mouse.x-player.x,mouse.y-player.y)<=DIG_RANGE;
    // Range circle (dashed-ish via arc)
    ctx.strokeStyle='#ccbbaa55';ctx.lineWidth=1;
    ctx.setLineDash([4,4]);ctx.beginPath();ctx.arc(player.x,player.y,DIG_RANGE,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);
    // Highlight hovered tile
    if(tr>=0&&tr<ROWS&&tc>=0&&tc<COLS){
      const isWall=map[tr][tc]===1;
      ctx.fillStyle=isWall&&inRange?'#ccbbaa44':'#ffffff11';
      ctx.fillRect(tc*TILE,tr*TILE,TILE,TILE);
      if(isWall&&inRange){
        ctx.strokeStyle=player.digCooldown>0?'#ccbbaa44':'#ccbbaacc';ctx.lineWidth=2;
        ctx.strokeRect(tc*TILE,tr*TILE,TILE,TILE);
        ctx.fillStyle='#ccbbaaee';ctx.font='6px "Press Start 2P"';ctx.textAlign='center';
        ctx.fillText('â›',tc*TILE+TILE/2,tr*TILE+TILE/2+3);
      }
    }
  }
  // Reload bar
  if(pl.reloading>0&&aw&&aw.type!=='melee'){
    const prog=1-pl.reloading/aw.reloadTime;
    ctx.fillStyle='#00000099';ctx.fillRect(pl.x-25,pl.y+18,50,6);
    ctx.fillStyle='#c8ff00';ctx.fillRect(pl.x-25,pl.y+18,50*prog,6);
  }
  if(enemies.length===0&&gameActive){
    const sec=Math.ceil((180-waveTimer)/60);
    ctx.fillStyle='#ffffffaa';ctx.font='6px "Press Start 2P"';ctx.textAlign='center';
    ctx.fillText('Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ°Ñ Ğ²Ğ¾Ğ»Ğ½Ğ°: '+sec+'Ñ',W/2,H-10);
  }
  drawMinimap();
  drawBottomHUD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOTTOM HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawBottomHUD(){
  bhud.clearRect(0,0,W,BH);
  // Background bar
  bhud.fillStyle='#000000cc';bhud.fillRect(0,0,W,BH);
  bhud.strokeStyle='#c8ff0033';bhud.lineWidth=1;bhud.strokeRect(0,0,W,BH);

  // â”€â”€â”€ WEAPON SLOTS (left-center) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const slotW=130,slotH=60,slotGap=8;
  const slotsStartX=Math.floor(W/2)- slotW - slotGap/2;
  const slotsY=11;

  for(let s=0;s<2;s++){
    const sx=slotsStartX+s*(slotW+slotGap),sy=slotsY;
    const isActive=s===player.activeSlot;
    const w=player.weapons[s];

    // Slot border
    bhud.strokeStyle=isActive?'#c8ff00':'#334433';
    bhud.lineWidth=isActive?2:1;
    bhud.strokeRect(sx,sy,slotW,slotH);
    bhud.fillStyle=isActive?'#c8ff0010':'#111111';
    bhud.fillRect(sx+1,sy+1,slotW-2,slotH-2);

    // Slot number
    bhud.fillStyle=isActive?'#c8ff00':'#446644';
    bhud.font='6px "Press Start 2P"';
    bhud.textAlign='left';
    bhud.fillText('['+(s+1)+']',sx+4,sy+11);

    if(w){
      // Weapon color bar
      bhud.fillStyle=w.color||'#aaaaaa';
      bhud.shadowBlur=isActive?8:0;bhud.shadowColor=w.color||'#aaaaaa';
      // Draw weapon silhouette
      const wx=sx+10,wy=sy+22;
      bhud.fillRect(wx,wy,w.bw*3.2,w.bh*3.2);
      // Barrel
      bhud.fillStyle='#ffffff55';bhud.fillRect(wx+w.bw*3.2,wy+w.bh*1,6,w.bh*1.2);
      if(w.silenced){bhud.fillStyle='#778877';bhud.fillRect(wx+w.bw*3.2+6,wy+w.bh*.8,10,w.bh*1.5);}
      bhud.shadowBlur=0;
      // Name
      bhud.fillStyle=isActive?'#ffffff':'#aaaaaa';
      bhud.font='4px "Press Start 2P"';bhud.textAlign='left';
      bhud.fillText(w.name,sx+4,sy+slotH-14);
      // Ammo
      bhud.fillStyle=isActive?'#c8ff00':'#667766';
      bhud.font='5px "Press Start 2P"';
      bhud.fillText(w.ammo+'/'+w.maxAmmo+'  +'+w.totalAmmo,sx+4,sy+slotH-5);
    } else {
      // Empty slot
      bhud.fillStyle='#334433';
      bhud.font='5px "Press Start 2P"';bhud.textAlign='center';
      bhud.fillText('ĞŸĞ£Ğ¡Ğ¢Ğ',sx+slotW/2,sy+slotH/2+2);
    }
  }

  // Active weapon full ammo info (top strip)
  const aw=getWeapon();
  if(player.digMode){
    bhud.fillStyle='#ccbbaacc';bhud.font='5px "Press Start 2P"';bhud.textAlign='center';
    bhud.shadowBlur=8;bhud.shadowColor='#ccbbaa';
    bhud.fillText('â› Ğ Ğ•Ğ–Ğ˜Ğœ ĞšĞĞŸĞšĞ˜ â€” Ğ›ĞšĞœ Ğ¿Ğ¾ ÑÑ‚ĞµĞ½Ğµ (Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ 2 ĞºĞ»ĞµÑ‚ĞºĞ¸) â€” F Ğ´Ğ»Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°',W/2,8);
    bhud.shadowBlur=0;
  } else if(aw&&aw.type!=='melee'){
    bhud.fillStyle='#c8ff00aa';bhud.font='5px "Press Start 2P"';bhud.textAlign='center';
    bhud.fillText('â–¼ '+aw.name+'   |   '+aw.ammo+' Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ   +'+aw.totalAmmo+' Ğ·Ğ°Ğ¿Ğ°Ñ',W/2,8);
  } else if(!aw){
    bhud.fillStyle='#aa6633aa';bhud.font='5px "Press Start 2P"';bhud.textAlign='center';
    bhud.fillText('ğŸªµ Ğ”Ğ£Ğ‘Ğ˜ĞĞ â€” Ğ‘Ğ›Ğ˜Ğ–ĞĞ˜Ğ™ Ğ‘ĞĞ™',W/2,8);
  }

  // â”€â”€â”€ INVENTORY (right side) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const invX=slotsStartX+2*(slotW+slotGap)+20;
  const invY=slotsY;
  const iSlotS=28;

  bhud.fillStyle='#c8ff0066';bhud.font='5px "Press Start 2P"';bhud.textAlign='left';
  bhud.fillText('Ğ˜ĞĞ’Ğ•ĞĞ¢ĞĞ Ğ¬',invX,invY-2);

  for(let i=0;i<4;i++){
    const ix=invX+(i%2)*(iSlotS+4);
    const iy=invY+4+Math.floor(i/2)*(iSlotS+4);
    const item=player.inventory[i];
    const isPickaxeActive=item&&item.type==='pickaxe'&&player.digMode;
    bhud.strokeStyle=isPickaxeActive?'#ccbbaa':item?'#aaaaaa':'#333333';
    bhud.lineWidth=isPickaxeActive?2:1;bhud.strokeRect(ix,iy,iSlotS,iSlotS);
    bhud.fillStyle=isPickaxeActive?'#ccbbaa22':'#111111';bhud.fillRect(ix+1,iy+1,iSlotS-2,iSlotS-2);
    // Key hint
    bhud.fillStyle='#555555';bhud.font='4px "Press Start 2P"';bhud.textAlign='left';
    bhud.fillText('['+(i+3)+']',ix+2,iy+8);
    if(item){
      const def=ITEMS[item.type];
      bhud.shadowBlur=isPickaxeActive?12:8;bhud.shadowColor=def.glow;
      bhud.fillStyle=def.color;
      if(item.type==='pickaxe'){
        // Draw pickaxe icon
        bhud.save();bhud.translate(ix+14,iy+16);bhud.rotate(-0.6);
        bhud.fillStyle='#ccbbaa';bhud.fillRect(-8,-2,16,3); // handle
        bhud.fillStyle='#aaaaaa';bhud.fillRect(6,-5,5,9);   // head
        bhud.fillStyle='#888888';bhud.fillRect(7,-4,3,7);   // blade
        bhud.restore();
        // Active indicator
        if(isPickaxeActive){
          bhud.fillStyle='#ccbbaacc';bhud.font='4px "Press Start 2P"';bhud.textAlign='center';
          bhud.fillText('ĞšĞĞŸĞšĞ',ix+iSlotS/2,iy+iSlotS-3);
        } else {
          bhud.fillStyle='#888888';bhud.font='4px "Press Start 2P"';bhud.textAlign='center';
          bhud.fillText('[F]',ix+iSlotS/2,iy+iSlotS-3);
        }
      } else if(item.type==='goz'){
        bhud.beginPath();bhud.arc(ix+10,iy+18,5,0,Math.PI*2);bhud.fill();
        bhud.beginPath();bhud.arc(ix+18,iy+20,5,0,Math.PI*2);bhud.fill();
        bhud.beginPath();bhud.arc(ix+14,iy+13,5,0,Math.PI*2);bhud.fill();
        bhud.fillStyle='#ffaaee';bhud.beginPath();bhud.arc(ix+10,iy+17,2,0,Math.PI*2);bhud.fill();
        bhud.beginPath();bhud.arc(ix+18,iy+18,2,0,Math.PI*2);bhud.fill();
        bhud.fillStyle='#ffffff88';bhud.font='4px "Press Start 2P"';bhud.textAlign='center';
        bhud.fillText(def.name.substring(0,5),ix+iSlotS/2,iy+iSlotS-3);
      } else {
        bhud.fillRect(ix+10,iy+9,8,13);bhud.fillStyle='#ffffff55';bhud.fillRect(ix+10,iy+10,4,6);
        bhud.fillStyle=def.color;bhud.fillRect(ix+11,iy+7,6,3);
        bhud.fillStyle='#ffffff88';bhud.font='4px "Press Start 2P"';bhud.textAlign='center';
        bhud.fillText(def.name.substring(0,6),ix+iSlotS/2,iy+iSlotS-3);
      }
      bhud.shadowBlur=0;
    }
  }

  // â”€â”€â”€ LEFT SIDE: health + stealth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const lx=18,ly=slotsY;
  bhud.fillStyle='#777777';bhud.font='5px "Press Start 2P"';bhud.textAlign='left';bhud.fillText('HP',lx,ly+8);
  // HP bar large
  bhud.fillStyle='#1a1a1a';bhud.fillRect(lx,ly+12,90,10);
  bhud.fillStyle='#ff3030';bhud.shadowBlur=4;bhud.shadowColor='#ff3030';
  bhud.fillRect(lx,ly+12,90*(player.hp/player.maxHp),10);
  bhud.shadowBlur=0;
  bhud.fillStyle='#ffffff88';bhud.font='5px "Press Start 2P"';bhud.textAlign='center';
  bhud.fillText(player.hp+'/'+player.maxHp,lx+45,ly+21);
  // Stealth indicator
  if(player.stealth){
    bhud.fillStyle='#88ccff';bhud.shadowBlur=6;bhud.shadowColor='#88ccff';
    bhud.font='5px "Press Start 2P"';bhud.textAlign='left';
    bhud.fillText('ğŸ‘ Ğ¡ĞšĞ Ğ«Ğ¢ĞĞĞ¡Ğ¢Ğ¬',lx,ly+38);bhud.shadowBlur=0;
  }
  bhud.fillStyle='#555555';bhud.font='4px "Press Start 2P"';bhud.textAlign='left';
  bhud.fillText('SHIFT: '+(player.stealth?'Ğ’ĞšĞ›':'Ğ’Ğ«ĞšĞ›'),lx,ly+50);

  // â”€â”€â”€ RIGHT SIDE: wave + kills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rx=W-110,ry=slotsY;
  bhud.fillStyle='#ff6060';bhud.font='5px "Press Start 2P"';bhud.textAlign='left';
  bhud.fillText('Ğ’ĞĞ›ĞĞ',rx,ry+8);
  bhud.fillStyle='#c8ff00';bhud.shadowBlur=6;bhud.shadowColor='#c8ff00';
  bhud.font='14px "Press Start 2P"';bhud.fillText(wave,rx,ry+28);bhud.shadowBlur=0;
  bhud.fillStyle='#ff6060';bhud.font='5px "Press Start 2P"';bhud.fillText('Ğ£Ğ‘Ğ˜Ğ™Ğ¡Ğ¢Ğ’',rx,ry+42);
  bhud.fillStyle='#ff6060';bhud.font='9px "Press Start 2P"';bhud.fillText(document.getElementById('kills').textContent,rx,ry+56);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MINIMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawMinimap(){
  mctx.fillStyle='#050508ee';mctx.fillRect(0,0,100,76);
  const sx=100/COLS,sy=76/ROWS;
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    if(!visited[r][c])continue;
    mctx.fillStyle=map[r][c]?'#1a1a2e':'#0f3460';mctx.fillRect(c*sx,r*sy,sx+.5,sy+.5);
  }
  for(const c of chests){if(c.open||c.collected)continue;mctx.fillStyle='#ffaa22';mctx.fillRect((c.x/W)*100-1,(c.y/H)*76-1,3,3);}
  for(const e of enemies){if(e.deathAnim>0)continue;mctx.fillStyle=e.type==='mutant'?'#ff6060':'#60ff60';mctx.fillRect((e.x/W)*100-1,(e.y/H)*76-1,2.5,2.5);}
  mctx.fillStyle='#c8ff00';mctx.fillRect((player.x/W)*100-2,(player.y/H)*76-2,4,4);
  mctx.strokeStyle='#c8ff0033';mctx.lineWidth=1;mctx.strokeRect(0,0,100,76);
}

function showAnn(txt){
  const el=document.getElementById('announce');el.textContent=txt;el.style.opacity='1';
  setTimeout(()=>el.style.opacity='0',2200);
}
function gameOver(){
  gameActive=false;
  const ov=document.getElementById('overlay');ov.style.display='flex';
  const k=document.getElementById('kills').textContent;
  ov.innerHTML=`<h1 style="color:#ff3030;text-shadow:0 0 20px #ff3030;font-size:16px">ğŸ’€ GAME OVER</h1>
    <div class="sub">Ğ’Ğ¾Ğ»Ğ½Ğ°: ${wave} &nbsp;|&nbsp; Ğ£Ğ±Ğ¸Ğ¹ÑÑ‚Ğ²: ${k}</div>
    <button class="btn" onclick="initAC();startGame()">â–¶ Ğ—ĞĞĞĞ’Ğ</button>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOOP + RESIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop(){if(!gameActive)return;update();render();requestAnimationFrame(loop);}
function resize(){
  const totalH=GH+BH+6; // canvas + hud + border
  const sc=Math.min(window.innerWidth/W,window.innerHeight/totalH)*.95;
  gw.style.transform=`scale(${sc})`;gw.style.transformOrigin='center center';
}
window.addEventListener('resize',resize);resize();
</script>
</body>
</html>
